<Window x:Name="NotesWindow"
        xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:HasteNotes.ViewModels"
        xmlns:conv="clr-namespace:HasteNotes.Converters"
        xmlns:markdown="clr-namespace:Markdown.Avalonia;assembly=Markdown.Avalonia"
        x:Class="HasteNotes.Views.Notes"
        x:DataType="vm:NotesViewModel"
        Width="900" Height="600"
        Title="{Binding Title}">

    <Window.Resources>
        <conv:NullOrCountGreaterThanZeroConverter x:Key="NullOrCountGreaterThanZeroConverter"/>
        <conv:GreaterThanZeroToBoolConverter x:Key="GreaterThanZeroToBoolConverter"/>
        <conv:NullToBoolConverter x:Key="NullToBoolConverter"/>
        <conv:NullToEmptyCollectionConverter x:Key="NullToEmptyCollectionConverter"/>
    </Window.Resources>

    <Grid x:Name="MainGrid" RowDefinitions="Auto,Auto,*,Auto"
          ColumnDefinitions="*,Auto">

        <!-- Menu -->
        <Menu Grid.Row="0" Grid.ColumnSpan="2">
            <MenuItem Header="_File">
                <MenuItem Header="_New"  Command="{Binding NewCommand}"/>
                <MenuItem Header="_Open" Command="{Binding OpenCommand}" />
                <MenuItem Header="_Save" Command="{Binding SaveCommand}"/>
                <MenuItem Header="_Settings" Command="{Binding SettingsCommand}"/>
                <Separator/>
                <MenuItem Header="Game Selection" Click="GameSelection_Click"/>
                <MenuItem Header="E_xit" Command="{Binding ExitCommand}"/>
            </MenuItem>
        </Menu>

        <!-- Toolbar -->
        <Grid Grid.Row="1" Grid.ColumnSpan="4"
              Margin="12,8"
              ColumnDefinitions="Auto,8,Auto,8,Auto,8,Auto">
            <Button Content="Add" Command="{Binding AddCommand}"/>
            <Rectangle Grid.Column="1" Width="8"/>
            <Button Grid.Column="2" Content="Edit" Command="{Binding EditCommand}"/>
            <Rectangle Grid.Column="3" Width="8"/>
            <Button Grid.Column="4" Content="Delete" Command="{Binding DeleteNoteCommand}"/>
            <Rectangle Grid.Column="4" Width="8"/>
            <Button Grid.Column="6" Content="Notes List" Command="{Binding ToggleNotesListCommand}"/>
        </Grid>

        <!-- NOTES - Drag and Drop -->
       <Border Grid.Row="2" Grid.Column="0"
                Margin="12"
                BorderThickness="1"
                BorderBrush="#CCC"
                CornerRadius="4"
                Padding="6"
                IsVisible="{Binding IsNotesListVisible}">

            <Border Grid.Row="2" Grid.Column="0"
                    Margin="12"
                    BorderThickness="1"
                    BorderBrush="#CCC"
                    CornerRadius="4"
                    Padding="6"
                    IsVisible="{Binding IsNotesListVisible}">

                <Grid RowDefinitions="Auto,*">
                    <!-- Header -->
                    <TextBlock Text="Notes List"
                               FontWeight="Bold"
                               Margin="4"
                               Grid.Row="0"/>
                  
                    <!-- Scrollable List -->
                    <ScrollViewer Grid.Row="1"
                                  Classes="draggableList"
                                  VerticalScrollBarVisibility="Auto"
                                  HorizontalScrollBarVisibility="Disabled">

                        <ListBox x:Name="NotesListBox"
                                 Classes="draggable"
                                 ItemsSource="{Binding Notes}">

                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <DockPanel Margin="4">
                                        <!-- Button aligned to the right -->
                                        <Button  Width="34"
                                                Height="30"
                                                Margin="4"
                                                DockPanel.Dock="Right"
                                                Click="GoToNote_Click"
                                                CommandParameter="{Binding}"
                                                ToolTip.Tip="Go to note">
                                                <PathIcon Width="16" Height="16" Data="M4 12 L18 12 L12 6 L14 4 L24 14 L14 24 L12 22 L18 16 L4 16 Z"/>
                                        </Button>

                                        <!-- Delete Button -->
                                        <Button Width="34"
                                                Height="30"
                                                Margin="4"
                                                DockPanel.Dock="Right"
                                                Background="#FFFFC0C0"
                                                Click="DeleteNote_Click"
                                                CommandParameter="{Binding}"
                                                ToolTip.Tip="Delete note">
                                                <PathIcon Width="16" Height="16"  Data="M3 6 L5 6 L21 6 L23 6 L23 8 L21 8 L19 26 L7 26 L5 8 L3 8 Z" />
                                        </Button>
                                        <!-- Note title on the left -->
                                        <TextBlock Text="{Binding Title}" VerticalAlignment="Center"/>
                                    </DockPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>

                    </ScrollViewer>
                </Grid>
            </Border>
        </Border>


        <!-- NOTES AREA -->
        <Grid Grid.Row="2" Grid.Column="0" Margin="12"
              RowDefinitions="Auto,Auto,*"
              IsVisible="{Binding !IsNotesListVisible}">

            <!-- Note title -->
            <TextBlock Grid.Row="0"
                       Text="{Binding SelectedNote?.Title}"
                       FontSize="18"
                       FontWeight="Bold"
                       IsVisible="{Binding SelectedNote, Converter={x:Static ObjectConverters.IsNotNull}}"/>

            <!-- Boss Info -->
            <StackPanel Grid.Row="1"
                        IsVisible="{Binding IsBossNoteVisible}"
                        Margin="0,8"
                        Spacing="8">

                <TextBlock Text="{Binding SelectedNote?.SelectedBoss?.BossName}"
                           FontWeight="Bold" IsVisible="{Binding SelectedNote?.SelectedBoss, Converter={StaticResource NullToBoolConverter}}"/>

                <!-- Headers -->
                 <Grid ColumnDefinitions="*,*,*" Margin="0,0,0,8">
                    <TextBlock Text="HP" FontWeight="Bold"                                
                               IsVisible="{Binding SelectedNote?.SelectedBoss?.VisibleSteals, Converter={StaticResource NullOrCountGreaterThanZeroConverter}}"/>
                    <TextBlock Text="Steals" Grid.Column="1" FontWeight="Bold"
                               IsVisible="{Binding SelectedNote?.SelectedBoss?.VisibleSteals, Converter={StaticResource NullOrCountGreaterThanZeroConverter}}"/>
                    <TextBlock Text="Items" Grid.Column="2" FontWeight="Bold"
                               IsVisible="{Binding SelectedNote?.SelectedBoss?.VisibleItems, Converter={StaticResource NullOrCountGreaterThanZeroConverter}}"/>
                </Grid>

                <!-- Data -->
                <Grid ColumnDefinitions="*,*,*">
                    <TextBlock Text="{Binding SelectedNote?.SelectedBoss?.Hp}"/>

                    <ItemsControl Grid.Column="1"
                                  ItemsSource="{Binding SelectedNote?.SelectedBoss?.VisibleSteals, Converter={StaticResource NullToEmptyCollectionConverter}}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Display}"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <ItemsControl Grid.Column="2"
                                  ItemsSource="{Binding SelectedNote?.SelectedBoss?.VisibleItems, Converter={StaticResource NullToEmptyCollectionConverter}}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Display}"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                </Grid>
            </StackPanel>

            <!-- Scrollable note content -->
           <Border Grid.Row="2"
                    BorderBrush="#DDD"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="6">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <markdown:MarkdownScrollViewer Markdown="{Binding SelectedNote?.Content}" />
                </ScrollViewer>
            </Border>

        </Grid>

        <!-- CHECKLIST SIDEBAR -->
        <Border Grid.Row="2" Grid.Column="1"
                Margin="8,12,12,12"
                BorderBrush="#DDD"
                BorderThickness="1"
                CornerRadius="4"
                Padding="12"
                IsVisible="{Binding ShowChecklist, Mode=TwoWay}">

            <Grid RowDefinitions="Auto,Auto,*">

                <!-- Header -->
                <TextBlock Grid.Row="0" Text="Checklist" FontWeight="Bold" Margin="0,0,0,8"/>

                <!-- Input for new checklist item -->
                <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="4" Margin="0,0,0,8">
                    <TextBox Width="200"
                             Watermark="New item"
                             Text="{Binding NewChecklistText, UpdateSourceTrigger=PropertyChanged}"/>
                    <Button Content="Add"
                            Command="{Binding AddChecklistCommand}"/>
                </StackPanel>

                <!-- Scrollable checklist -->
                <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding Checklist}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,2" ColumnDefinitions="*,Auto">
                                    <!-- Checkbox -->
                                    <CheckBox Grid.Column="0"
                                              IsChecked="{Binding IsChecked}"
                                              Content="{Binding Text}"
                                              VerticalAlignment="Center"/>

                                    <!-- Remove button -->
                                    <Button Grid.Column="1"
                                            Content="&#x2715;"
                                            Width="24"
                                            Height="24"
                                            Padding="0"
                                            Margin="4,0,0,0"
                                            VerticalAlignment="Center"
                                            Background="Transparent"
                                            BorderBrush="Transparent"
                                            Click="RemoveChecklist_Click"
                                            CommandParameter="{Binding}"/>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

            </Grid>
        </Border>


        <!-- Navigation -->
        <Grid Grid.Row="3" Grid.ColumnSpan="2"
              Margin="12,0,12,12"
              ColumnDefinitions="*,Auto,8,Auto,*"
              IsVisible="{Binding !IsNotesListVisible}">

            <Button Grid.Column="1"
                    Content="Prev"
                    Width="120"
                    Command="{Binding PrevCommand}"/>

            <Button Grid.Column="3"
                    Content="Next"
                    Width="120"
                    Command="{Binding NextCommand}"/>

        </Grid>

    </Grid>
</Window>
